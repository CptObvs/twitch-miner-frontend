<div class="mx-auto max-w-4xl h-full flex flex-col pb-6">
  <!-- Back Link -->
  <a
    routerLink="/dashboard"
    class="mb-4 shrink-0 inline-flex items-center gap-2 text-sm font-medium text-gray-400 transition-colors hover:text-twitch-light"
  >
    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
    </svg>
    Back to Dashboard
  </a>

  @if (loading()) {
    <div class="flex flex-1 items-center justify-center">
      <app-loading-view [large]="true" />
    </div>
  } @else if (error()) {
    <app-error-view [message]="error()" />
  } @else if (instance()) {
    <div class="flex-1 min-h-0 flex flex-col gap-4">
      <!-- Hero Section -->
      <div
        [class]="
          'shrink-0 rounded-2xl border p-4 ' +
          (isRunning()
            ? 'border-twitch/30 bg-gradient-to-br from-gray-900 via-gray-900 to-twitch/5 shadow-xl shadow-twitch/20'
            : 'border-gray-800 bg-gray-900')
        "
      >
        <!-- Header -->
        <div class="flex flex-wrap items-start justify-between gap-3 mb-3">
          <div class="flex-1">
            <h1
              class="text-xl font-bold mb-1 font-mono"
              [class]="isRunning() ? 'gradient-text' : 'text-gray-100'"
            >
              {{
                !isTwitchDropsMiner() && instance()!.twitch_username
                  ? instance()!.twitch_username
                  : instance()!.id.slice(0, 12)
              }}
            </h1>
            <p class="text-xs text-gray-500 font-mono">{{ instance()!.id }}</p>
          </div>
          <div class="flex flex-col gap-1.5 items-end">
            <div class="flex items-center gap-2">
              <a
                [href]="
                  isTwitchDropsMiner()
                    ? 'https://github.com/rangermix/TwitchDropsMiner'
                    : 'https://github.com/rdavydov/Twitch-Channel-Points-Miner-v2'
                "
                target="_blank"
                rel="noopener"
                class="rounded-md px-1.5 py-0.5 text-[10px] font-semibold transition-opacity hover:opacity-70"
                [class]="
                  isTwitchDropsMiner()
                    ? 'bg-blue-900/40 text-blue-300'
                    : 'bg-orange-900/40 text-orange-300'
                "
              >
                {{ isTwitchDropsMiner() ? 'Docker' : 'Twitch Miner V2' }}
              </a>
              <app-status-badge [running]="isRunning()" [stopping]="stopping()" />
            </div>
            <app-uptime-timer
              [startedAt]="instance()!.last_started_at ?? null"
              [isRunning]="isRunning()"
            />
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-2">
          @if (isRunning() || stopping()) {
            <button
              (click)="stopInstance()"
              [disabled]="actionLoading()"
              class="rounded-lg bg-gradient-to-r from-red-900/50 to-red-800/50 border border-red-700/30 px-4 py-2 text-xs font-bold text-red-300 transition-all duration-200 hover:from-red-900 hover:to-red-800 hover:shadow-lg hover:shadow-red-900/30 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
            >
              @if (stopping()) {
                <span class="inline-flex items-center gap-2">
                  <app-loading-spinner size="sm" color="red" />
                  Stopping…
                </span>
              } @else {
                Stop Instance
              }
            </button>
          } @else {
            <button
              (click)="startInstance()"
              [disabled]="actionLoading()"
              class="rounded-lg bg-gradient-to-r from-green-900/50 to-emerald-900/50 border border-green-700/30 px-4 py-2 text-xs font-bold text-green-300 transition-all duration-200 hover:from-green-900 hover:to-emerald-900 hover:shadow-lg hover:shadow-green-900/30 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95"
            >
              @if (actionLoading()) {
                <span class="inline-flex items-center gap-2">
                  <app-loading-spinner size="sm" color="green" />
                  Starting…
                </span>
              } @else {
                Start Instance
              }
            </button>
          }

          @if (isRunning() && uiUrl()) {
            <div class="relative">
              @if (isFirstStart()) {
                <span
                  class="absolute -inset-0.5 rounded-lg bg-twitch/50 blur animate-pulse pointer-events-none"
                ></span>
              }
              <a
                [href]="uiUrl()!"
                target="_blank"
                rel="noopener"
                class="relative inline-flex flex-col items-center justify-center gap-0 rounded-lg bg-twitch/90 border border-twitch-light/30 px-4 py-1.5 font-bold text-white transition-all duration-200 hover:bg-twitch active:scale-95"
              >
                <span class="inline-flex items-center gap-2 text-xs">
                  <svg
                    class="h-3.5 w-3.5"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="2"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25"
                    />
                  </svg>
                  Open Miner UI
                </span>
                @if (isFirstStart()) {
                  <span class="text-[10px] font-normal text-white/70">Setup required</span>
                }
              </a>
            </div>
          }
        </div>

        <!-- Activation Banner (subprocess only) -->
        @if (hasActivationCode()) {
          <div class="mt-3 rounded-lg border border-yellow-600/30 bg-yellow-900/15 px-3 py-2">
            <div class="flex items-center gap-2">
              <span class="text-[10px] font-semibold text-yellow-400">Twitch Activation</span>
              <span class="font-mono text-xs font-bold text-yellow-200">{{
                instance()!.activation_code
              }}</span>
            </div>
            <a
              [href]="'https://www.twitch.tv/activate?device-code=' + instance()!.activation_code"
              target="_blank"
              rel="noopener"
              class="mt-0.5 block text-xs text-yellow-500 underline hover:text-yellow-300"
              >→ twitch.tv/activate</a
            >
          </div>
        }

        <!-- Info Grid -->
        <div class="mt-3 border-t border-gray-800/60 pt-3">
          <div class="grid grid-cols-2 gap-2 md:grid-cols-3">
            <!-- Created -->
            <div
              class="flex w-full items-center justify-between gap-2 rounded-lg border border-gray-800 bg-gray-900 px-3 py-2 text-[11px] text-gray-400"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="h-3.5 w-3.5 text-blue-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5"
                  />
                </svg>
                <span>Created</span>
              </div>
              <span class="text-xs font-semibold text-gray-200 whitespace-nowrap">{{
                formatDate(instance()!.created_at)
              }}</span>
            </div>

            <!-- Last Started -->
            <div
              class="flex w-full items-center justify-between gap-2 rounded-lg border border-gray-800 bg-gray-900 px-3 py-2 text-[11px] text-gray-400"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="h-3.5 w-3.5 text-green-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z"
                  />
                </svg>
                <span>Last Started</span>
              </div>
              <span class="text-xs font-semibold text-gray-200 whitespace-nowrap">
                {{
                  instance()!.last_started_at ? formatDate(instance()!.last_started_at!) : 'Never'
                }}
              </span>
            </div>

            <!-- Last Stopped -->
            <div
              class="flex w-full items-center justify-between gap-2 rounded-lg border border-gray-800 bg-gray-900 px-3 py-2 text-[11px] text-gray-400"
            >
              <div class="flex items-center gap-2">
                <svg
                  class="h-3.5 w-3.5 text-red-400"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z"
                  />
                </svg>
                <span>Last Stopped</span>
              </div>
              <span class="text-xs font-semibold text-gray-200 whitespace-nowrap">
                {{
                  instance()!.last_stopped_at ? formatDate(instance()!.last_stopped_at!) : 'Never'
                }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Subprocess-only: Streamers Editor -->
      @if (!isTwitchDropsMiner()) {
        <app-streamers-editor
          class="block shrink-0"
          [instanceId]="instance()!.id"
          [streamers]="instance()!.streamers"
        />
      }

      <!-- Log Viewer — fills remaining space (Docker only when running) -->
      @if (!isTwitchDropsMiner() || isRunning()) {
        <app-log-viewer
          class="block flex-1 min-h-48"
          [instanceId]="instance()!.id"
          [fill]="true"
          [full]="true"
        />
      }
    </div>
  }
</div>
